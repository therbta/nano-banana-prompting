name: Auto-add Approved Prompt

on:
  issues:
    types: [labeled]

jobs:
  add-prompt:
    if: github.event.label.name == 'Approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue and add to data.json
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Parse form data
            const parseField = (label) => {
              const regex = new RegExp(`### ${label}\\s*([\\s\\S]*?)(?=###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const promptType = parseField('Prompt Type').toLowerCase();
            const hasReference = parseField('Can it be used with a reference image\\?').toLowerCase();
            const genericPrompt = parseField('Generic Prompt');
            const referencePrompt = parseField('Reference Prompt \\(If applicable\\)');
            const imageUrl = parseField('Example Image URL \\(Optional\\)');
            
            // Read existing data
            const data = JSON.parse(fs.readFileSync('data.json', 'utf8'));
            
            // Generate new ID
            const newId = Math.max(...data.map(p => p.id)) + 1;
            
            // Create new prompt object
            const newPrompt = {
              id: newId,
              tweetId: `issue-${issue.number}`,
              twitterUrl: issue.html_url,
              promptType: promptType,
              model: "Nano Banana Pro",
              imageUrls: imageUrl ? [imageUrl] : [],
              prompt: genericPrompt,
              formattedPrompt: genericPrompt
            };
            
            // Add prompts structure if has reference
            if (hasReference === 'yes' && referencePrompt) {
              newPrompt.prompts = {
                generic: genericPrompt,
                withReferenceUpload: referencePrompt
              };
              newPrompt.formattedPrompts = {
                generic: genericPrompt,
                withReferenceUpload: referencePrompt
              };
            }
            
            // Add to data
            data.push(newPrompt);
            
            // Write back
            fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
            
            console.log(`Added prompt ID ${newId} from issue #${issue.number}`);
            return { newId, promptType };

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b add-prompt-${{ github.event.issue.number }} || git checkout add-prompt-${{ github.event.issue.number }}
          git add data.json
          git commit -m "Add prompt from issue #${{ github.event.issue.number }}" || echo "No changes to commit"
          git push -f origin add-prompt-${{ github.event.issue.number }}
      
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Add Prompt: Issue #${{ github.event.issue.number }}',
              head: 'add-prompt-${{ github.event.issue.number }}',
              base: 'main',
              body: `Auto-generated PR from approved issue #${{ github.event.issue.number }}\n\nPlease review and merge if everything looks correct.\n\nCloses #${{ github.event.issue.number }}`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['auto-generated']
            });
